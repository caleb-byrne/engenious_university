name: AI Red Team Security Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  red-team-security-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Red Team Docker image
      run: |
        cd promptfoo
        docker build -f Red-Teaming/Dockerfile.redteam -t promptfoo-redteam:${{ github.sha }} ./Red-Teaming
        
    - name: Run AI Red Team Tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd promptfoo
        mkdir -p Red-Teaming/output
        docker run --rm \
          -e OPENAI_API_KEY="$OPENAI_API_KEY" \
          -v "$(pwd)/Red-Teaming/output:/app/output" \
          promptfoo-redteam:${{ github.sha }}
          
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: red-team-results-${{ github.sha }}
        path: promptfoo/Red-Teaming/output/
        retention-days: 30
        
    - name: Analyze Results for Security Issues
      id: security-check
      run: |
        cd promptfoo/Red-Teaming/output
        if [ -f results.json ]; then
          # Check for failures or concerning patterns
          FAILURES=$(jq '.results[].success | select(. == false)' results.json | wc -l)
          echo "Security test failures: $FAILURES"
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          
          if [ "$FAILURES" -gt 0 ]; then
            echo "âš ï¸ Security vulnerabilities detected in AI model responses!"
            jq '.results[] | select(.success == false) | .prompt' results.json
          fi
        else
          echo "âŒ No results file found"
          exit 1
        fi
        
    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const failures = '${{ steps.security-check.outputs.failures }}';
          const body = failures > 0 
            ? `ðŸš¨ **AI Security Alert**: ${failures} red team tests failed. Please review the security test results before merging.`
            : `âœ… **AI Security**: All red team tests passed. No security vulnerabilities detected.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: Fail on Security Issues (Optional)
      if: steps.security-check.outputs.failures > 0
      run: |
        echo "Failing build due to security issues. Set ALLOW_SECURITY_FAILURES=true to skip this check."
        # Uncomment the next line to fail the build on security issues
        # exit 1